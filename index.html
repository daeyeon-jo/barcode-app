<!DOCTYPE html>
<html>
<head>
  <title>ì¬ë¬¼ì¡°ì‚¬ ì›¹ì•±</title>
  <meta charset="UTF-8" />
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <h2>ğŸ“± ì¬ë¬¼ì¡°ì‚¬ ë°”ì½”ë“œ ì‹œìŠ¤í…œ</h2>

  <div id="setup">
    <label>ì§ë²ˆ: <input type="text" id="staffId" placeholder="ì˜ˆ: 123456" /></label>
    <button onclick="startScan()">ì‹œì‘</button>
  </div>

  <div id="scanner" style="display:none;">
    <p><b>ğŸ“· ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”</b></p>
    <div id="reader" style="width:300px;"></div>
    <div id="assetInfo" style="margin-top:10px;"></div>
    <div id="locationInput" style="display:none;">
      <label>ì„¸ë¶€ìœ„ì¹˜ê°€ ë‹¤ë¥¼ ê²½ìš° ì…ë ¥: <input type="text" id="newLocation" placeholder="ì°½ì¡°ê´€ 3ì¸µ ë³µë„" /></label>
      <button onclick="submitLocation()">ìœ„ì¹˜ ê¸°ë¡</button>
    </div>
  </div>

  <script>
    let scannedCode = "";
    let staffId = "";
    let scanner;  // ì „ì—­ë³€ìˆ˜ë¡œ ìŠ¤ìºë„ˆ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥
    const endpoint = "https://script.google.com/macros/s/AKfycbw82Gi8YXuFKTDhrmats5YSwQHFud-qiMObqYMOM4An9bEw7g1xllWt6cxS9nntaeGZcg/exec";

    function startScan() {
      staffId = document.getElementById("staffId").value.trim();
      if (!staffId) {
        alert("ì§ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
        return;
      }

      document.getElementById("setup").style.display = "none";
      document.getElementById("scanner").style.display = "block";

      scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
      scanner.render(onScanSuccess);
    }

    function onScanSuccess(decodedText) {
      scannedCode = decodedText;

      fetch(endpoint, {
        method: "POST",
        body: JSON.stringify({ code: scannedCode, staffId }),
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "error") {
          alert("âŒ ì˜¤ë¥˜: " + data.message);
          scanner.clear();  // ì´ˆê¸°í™”
          return;
        }
        if (data.status === "same") {
          alert("âœ… ìœ„ì¹˜ ë™ì¼, ê¸°ë¡ ìƒëµë¨");
          scanner.clear();  // ì´ˆê¸°í™”
          return;
        }
        if (data.status === "updated") {
          alert("âœ… ìœ„ì¹˜ ë³€ê²½ ê¸°ë¡ ì™„ë£Œ");
          scanner.clear();  // ì´ˆê¸°í™”
          return;
        }
        if (data.status === "show") {
          document.getElementById("assetInfo").innerHTML =
            `<b>ìì‚°ëª…:</b> ${data.asset}<br><b>ê¸°ì¡´ ìœ„ì¹˜:</b> ${data.originalLocation}<br><br>í˜„ì¬ ìœ„ì¹˜ê°€ ë‹¤ë¥´ë©´ ì•„ë˜ì— ì…ë ¥í•˜ì„¸ìš”.`;
          document.getElementById("locationInput").style.display = "block";
          scanner.clear();  // ìŠ¤ìº” ë©ˆì¶¤ - ìœ„ì¹˜ ì…ë ¥ ëŒ€ê¸°
        }
      });
    }

    function submitLocation() {
      const newLocation = document.getElementById("newLocation").value.trim();
      if (!newLocation) {
        alert("ìœ„ì¹˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      fetch(endpoint, {
        method: "POST",
        body: JSON.stringify({ code: scannedCode, staffId, newLocation }),
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        document.getElementById("assetInfo").innerText = "";
        document.getElementById("locationInput").style.display = "none";
        document.getElementById("newLocation").value = "";
        scanner.render(onScanSuccess);  // ìœ„ì¹˜ ê¸°ë¡ í›„ ë‹¤ì‹œ ìŠ¤ìº” ì‹œì‘
      });
    }
  </script>
</body>
</html>
